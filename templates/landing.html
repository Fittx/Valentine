<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Valentine's Day ðŸŒ»</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <style>
        /* Music player styles now live in static/css/style.css */
    </style>

</head>
<body>
    <div class="bees-background">
        <div class="bee"></div>
        <div class="bee"></div>
        <div class="bee"></div>
        <div class="bee"></div>
        <div class="bee"></div>
    </div>

    <div class="container fade-in">
        <div class="card">
            <h1 class="title">Hello Hermosa >_<</h1>
            <p class="subtitle">I have something special to ask you...</p>

            <form action="/submit-name" method="POST" class="form">
                <div class="form-group">
                    <label for="name">btw, what's your name?</label>
                    <input
                        type="text"
                        id="name"
                        name="name"
                        placeholder="Enter your name"
                        required
                        autocomplete="off"
                    >
                </div>
                <button type="submit" class="btn btn-primary">
                    Continue
                </button>
            </form>
        </div>
    </div>

    <div class="flower-decoration"></div>

    <!-- Music Player - Always visible now -->
    <div class="music-player" id="musicPlayer">
        <button class="music-toggle" id="musicToggle">
            <img id="musicIcon" src="{{ url_for('static', filename='icons/play.png') }}" alt="Play">
        </button>
        <div class="music-info">
            <div id="nowPlaying">Click to play music</div>
        </div>
        <div class="volume-control">
            <img id="volumeIcon" class="volume-icon" src="{{ url_for('static', filename='icons/volume_up.png') }}" alt="Volume">
            <input type="range" min="0" max="100" value="70" class="volume-slider" id="volumeSlider">
        </div>
    </div>

    <!-- Audio Element -->
    <audio id="bgMusic" preload="auto"></audio>

    <script src="{{ url_for('static', filename='js/script.js') }}"></script>

    <script>
        // ========== MUSIC PLAYER - LANDING PAGE ==========
        const playlist = [
            { title: "See You Again", src: "{{ url_for('static', filename='music/1. See.mp3') }}" },
            { title: "Glitter", src: "{{ url_for('static', filename='music/2. Gli.mp3') }}" },
            { title: "Sometimes", src: "{{ url_for('static', filename='music/3. Sometimes.mp3') }}" },
            { title: "Daze", src: "{{ url_for('static', filename='music/4. Daze.mp3') }}" },
            { title: "Infrunami", src: "{{ url_for('static', filename='music/5. Infr.mp3') }}" },
            { title: "C u girl", src: "{{ url_for('static', filename='music/6. C u.mp3') }}" },
            { title: "Boyfriend", src: "{{ url_for('static', filename='music/7. Boy.mp3') }}" },
            { title: "Perfect Love", src: "{{ url_for('static', filename='music/8. Perfect.mp3') }}" },
            { title: "Sweet / ITYWTD", src: "{{ url_for('static', filename='music/9. Sweet.mp3') }}" },
            { title: "Some", src: "{{ url_for('static', filename='music/10. Some.mp3') }}" }
        ];

        const iconPlay = "{{ url_for('static', filename='icons/play.png') }}";
        const iconPause = "{{ url_for('static', filename='icons/pause.png') }}";
        const iconVolUp = "{{ url_for('static', filename='icons/volume_up.png') }}";
        const iconVolOff = "{{ url_for('static', filename='icons/volume_off.png') }}";

        let currentSongIndex = 0;
        let shuffledPlaylist = [...playlist];
        let isPlaying = false;

        const audio = document.getElementById('bgMusic');
        const musicToggle = document.getElementById('musicToggle');
        const musicIcon = document.getElementById('musicIcon');
        const nowPlaying = document.getElementById('nowPlaying');
        const volumeSlider = document.getElementById('volumeSlider');
        const volumeIcon = document.getElementById('volumeIcon');

        const setToggleIcon = (playing) => {
            musicIcon.src = playing ? iconPause : iconPlay;
            musicIcon.alt = playing ? 'Pause' : 'Play';
        };

        const setVolumeIcon = (vol) => {
            volumeIcon.src = vol <= 0.001 ? iconVolOff : iconVolUp;
            volumeIcon.alt = vol <= 0.001 ? 'Muted' : 'Volume';
        };

        // Shuffle the playlist
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        // Initialize
        shuffledPlaylist = shuffleArray([...playlist]);
        audio.src = shuffledPlaylist[0].src;
        nowPlaying.textContent = shuffledPlaylist[0].title;
        audio.volume = 0.7;
        setToggleIcon(false);
        setVolumeIcon(audio.volume);

        // Arm first-interaction autoplay (click or keypress)
        let autoPlayArmed = false;
        function armAutoPlay() {
            if (autoPlayArmed) return;
            autoPlayArmed = true;
            const kickOff = () => {
                audio.play().then(() => {
                    isPlaying = true;
                    setToggleIcon(true);
                    nowPlaying.textContent = shuffledPlaylist[currentSongIndex].title;
                }).catch(() => {});
                document.removeEventListener('pointerdown', kickOff);
                document.removeEventListener('keydown', kickOff);
            };
            document.addEventListener('pointerdown', kickOff);
            document.addEventListener('keydown', kickOff);
        }
        armAutoPlay();

        // Play/Pause toggle
        musicToggle.addEventListener('click', function() {
            if (isPlaying) {
                audio.pause();
                isPlaying = false;
                setToggleIcon(false);
            } else {
                audio.play().then(() => {
                    isPlaying = true;
                    setToggleIcon(true);
                    nowPlaying.textContent = shuffledPlaylist[currentSongIndex].title;
                }).catch(e => {
                    console.log('Play error:', e);
                    nowPlaying.textContent = "Click again to play";
                });
            }
        });

        // Volume control
        volumeSlider.addEventListener('input', function() {
            audio.volume = this.value / 100;
            setVolumeIcon(audio.volume);
        });

        // Next song when current ends
        audio.addEventListener('ended', function() {
            currentSongIndex++;
            if (currentSongIndex >= shuffledPlaylist.length) {
                shuffledPlaylist = shuffleArray([...playlist]);
                currentSongIndex = 0;
            }
            audio.src = shuffledPlaylist[currentSongIndex].src;
            nowPlaying.textContent = shuffledPlaylist[currentSongIndex].title;
            audio.play();
            isPlaying = true;
            setToggleIcon(true);
        });

        // Save state before leaving page
        window.addEventListener('beforeunload', function() {
            sessionStorage.setItem('musicTime', audio.currentTime);
            sessionStorage.setItem('currentSong', currentSongIndex);
            sessionStorage.setItem('isPlaying', isPlaying);
            sessionStorage.setItem('volume', volumeSlider.value);
            sessionStorage.setItem('shuffledPlaylist', JSON.stringify(shuffledPlaylist));
        });
    </script>


</body>
</html>